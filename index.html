<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>French Vocabulary</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    .highlight { background-color: yellow; }
    button { margin: 5px; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background-color: #4CAF50; color: white; }
    .btn-secondary { background-color: #008CBA; color: white; }
    .btn-danger { background-color: #f44336; color: white; }
  </style>
</head>
<body>
  <h2>French Vocabulary Practice</h2>

  <div>
    <button onclick="showSheet(1)" class="btn-primary">Sheet 1</button>
    <button onclick="showSheet(2)" class="btn-primary">Sheet 2</button>
  </div>

  <div id="sheet1" style="display:none;">
    <h3>Sheet 1</h3>
    <button onclick="speakAll(sheet1Data)" class="btn-secondary">Speak All</button>
    <button onclick="togglePause()" class="btn-secondary">Pause/Resume</button>
    <button onclick="speakAndDownload(sheet1Data)" class="btn-danger">Speak & Download</button>
    <table id="table1"></table>
  </div>

  <div id="sheet2" style="display:none;">
    <h3>Sheet 2</h3>
    <button onclick="speakAll(sheet2Data)" class="btn-secondary">Speak All</button>
    <button onclick="togglePause()" class="btn-secondary">Pause/Resume</button>
    <button onclick="speakAndDownload(sheet2Data)" class="btn-danger">Speak & Download</button>
    <table id="table2"></table>
  </div>

<script>
const sheet1Data = [
  { french: "accepter", english: "to accept" },
  { french: "aimer", english: "to like, to love" },
  { french: "annuler", english: "to cancel" }
];

const sheet2Data = [
  { french: "casser", english: "to break" },
  { french: "chercher", english: "to look for" },
  { french: "commander", english: "to order" }
];

let currentUtterance = null;
let isPaused = false;

function showSheet(sheetNum) {
  document.getElementById("sheet1").style.display = sheetNum === 1 ? "block" : "none";
  document.getElementById("sheet2").style.display = sheetNum === 2 ? "block" : "none";
  populateTable(sheetNum);
}

function populateTable(sheetNum) {
  const table = document.getElementById(`table${sheetNum}`);
  const data = sheetNum === 1 ? sheet1Data : sheet2Data;
  table.innerHTML = "<tr><th>French</th><th>English</th></tr>";
  data.forEach((row, idx) => {
    table.innerHTML += `<tr id="row${sheetNum}-${idx}"><td>${row.french}</td><td>${row.english}</td></tr>`;
  });
}

function speakAll(data) {
  resetHighlights();
  let index = 0;

  function speakNext() {
    if (index < data.length) {
      const rowId = `row${document.getElementById("sheet1").style.display === "block" ? 1 : 2}-${index}`;
      document.querySelectorAll("tr").forEach(tr => tr.classList.remove("highlight"));
      document.getElementById(rowId).classList.add("highlight");

      const text = `${data[index].french}, ${data[index].english}`;
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.lang = "fr-FR";

      currentUtterance.onend = () => {
        index++;
        speakNext();
      };

      speechSynthesis.speak(currentUtterance);
    }
  }
  speakNext();
}

function togglePause() {
  if (!isPaused) {
    speechSynthesis.pause();
    isPaused = true;
  } else {
    speechSynthesis.resume();
    isPaused = false;
  }
}

function resetHighlights() {
  document.querySelectorAll("tr").forEach(tr => tr.classList.remove("highlight"));
}

// NEW FUNCTION: Speak & Download
function speakAndDownload(data) {
  resetHighlights();
  let index = 0;
  let audioChunks = [];
  const audioContext = new AudioContext();
  const dest = audioContext.createMediaStreamDestination();
  const mediaRecorder = new MediaRecorder(dest.stream);
  const source = audioContext.createMediaStreamSource(dest.stream); // required to keep context alive

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.onstop = () => {
    const blob = new Blob(audioChunks, { type: "audio/mp3" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "translations.mp3";
    a.click();
  };

  mediaRecorder.start();

  function speakNext() {
    if (index < data.length) {
      const rowId = `row${document.getElementById("sheet1").style.display === "block" ? 1 : 2}-${index}`;
      document.querySelectorAll("tr").forEach(tr => tr.classList.remove("highlight"));
      document.getElementById(rowId).classList.add("highlight");

      const text = `${data[index].french}, ${data[index].english}`;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "fr-FR";

      // Connect utterance audio to AudioContext
      const synth = window.speechSynthesis;
      utterance.onend = () => {
        index++;
        speakNext();
      };
      synth.speak(utterance);
    } else {
      setTimeout(() => mediaRecorder.stop(), 500);
    }
  }

  speakNext();
}
</script>
</body>
</html>
